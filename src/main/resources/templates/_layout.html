<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:fragment="layout(content)">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title th:text="${title} ?: 'Cocobolo - Sets de Cuna'">Cocobolo - Sets de Cuna</title>
  <link rel="icon" type="image/x-icon" th:href="@{/images/logo.ico}" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cocoSky: '#E0F2FE',
            cocoPink: '#FCE7F3',
            cocoMint: '#DCFCE7',
            cocoLav: '#EDE9FE',
            cocoText: '#334155',
            cocoPrimary: '#60A5FA',
            cocoAccent: '#F472B6'
          }
        }
      }
    }
  </script>
  <style>
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-slideUp { animation: slideUp 0.3s ease-out; }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .animate-bounce-slow { animation: bounce 2s infinite; }
    
    #chatMessages::-webkit-scrollbar { width: 6px; }
    #chatMessages::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
    #chatMessages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    #chatMessages::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-cocoSky via-cocoPink to-cocoMint text-cocoText">
  <!-- Header -->
  <header class="border-b border-white/50 backdrop-blur bg-white/50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-5">
        <img th:src="@{/images/coco7.png}" alt="Cocobolo" class="h-12 w-110 rounded-lg" />
        <div>
          <h1 class="text-xl md:text-2xl font-semibold tracking-tight">Cocobolo & Cocobaby</h1>
          <p class="text-sm text-slate-500">Tienda de sets de cuna</p>
        </div>
      </div>

      <!-- Nav -->
      <nav class="flex items-center gap-2">
        <a th:href="@{/productos}"
           class="px-3 py-2 rounded-full text-sm font-medium hover:shadow bg-white/70 hover:bg-white transition">Productos</a>
        <a th:href="@{/clientes}"
           class="px-3 py-2 rounded-full text-sm font-medium hover:shadow bg-white/70 hover:bg-white transition">Clientes</a>
        <a th:href="@{/pedidos}"
           class="px-3 py-2 rounded-full text-sm font-medium hover:shadow bg-white/70 hover:bg-white transition">Pedidos</a>
           <a th:href="@{/historia}"
           class="px-3 py-2 rounded-full text-sm font-medium hover:shadow bg-white/70 hover:bg-white transition">Historia</a>
        <a th:href="@{/citas}" 
        class="px-3 py-2 rounded-full text-sm font-medium hover:shadow bg-white/70 hover:bg-white transition">Agenda Dise√±o</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="bg-white/70 backdrop-blur rounded-2xl shadow-sm ring-1 ring-white/50">
      <div class="p-5 md:p-8" th:insert="${content}"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="mt-8 pb-8 text-center text-xs text-slate-500">
    Hecho con ‚ô• para los m√°s peque√±itos ‚Äî Cocobolo & Cocobaby
  </footer>

  <!-- ============================================ -->
  <!-- CHATBOT FLOTANTE -->
  <!-- ============================================ -->
  
  <!-- Bot√≥n Flotante -->
  <button 
    id="chatToggleBtn"
    onclick="toggleChat()"
    class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-cocoPrimary to-cocoAccent rounded-full shadow-2xl hover:scale-110 transition-transform duration-300 flex items-center justify-center text-white text-2xl z-50 animate-bounce-slow"
    title="Asistente Virtual"
  >
    üí¨
  </button>

  <!-- Ventana del Chat -->
  <div 
    id="chatWindow" 
    class="fixed bottom-24 right-6 w-96 max-w-[calc(100vw-3rem)] bg-white rounded-2xl shadow-2xl z-50 hidden animate-slideUp overflow-hidden"
    style="height: 550px;"
  >
    <!-- Header del Chat -->
    <div class="bg-gradient-to-r from-cocoPrimary to-cocoAccent text-white p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-xl">ü§ñ</div>
        <div>
          <h3 class="font-semibold">Asistente Cocobolo</h3>
          <p class="text-xs opacity-90">En l√≠nea</p>
        </div>
      </div>
      <button onclick="toggleChat()" class="hover:bg-white/20 rounded-full p-2 transition" title="Cerrar">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Mensajes -->
    <div id="chatMessages" class="h-[380px] overflow-y-auto p-4 space-y-3 bg-gradient-to-b from-slate-50 to-white">
      <div class="flex items-start gap-2">
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-cocoPrimary to-cocoAccent flex items-center justify-center text-white text-sm font-bold flex-shrink-0">ü§ñ</div>
        <div class="bg-white rounded-2xl rounded-tl-none px-4 py-2 shadow-sm max-w-[75%] border border-slate-100">
          <p class="text-sm">¬°Hola! üëã Soy tu asistente virtual. Puedo ayudarte con informaci√≥n sobre productos, precios, pedidos y m√°s. ¬øEn qu√© puedo ayudarte?</p>
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="p-3 bg-white border-t border-slate-200">
      <div class="flex gap-2">
        <input 
          type="text" 
          id="chatInput" 
          placeholder="Escribe tu mensaje..."
          class="flex-1 px-3 py-2 text-sm rounded-xl ring-1 ring-slate-200 focus:ring-cocoPrimary outline-none"
          onkeypress="if(event.key === 'Enter') sendChatMessage()"
        />
        <button 
          onclick="sendChatMessage()"
          id="chatSendBtn"
          class="px-4 py-2 rounded-xl bg-gradient-to-r from-cocoPrimary to-cocoAccent text-white font-semibold hover:opacity-90 transition shadow-md text-sm"
        >
          üì§
        </button>
      </div>
      <p class="text-[10px] text-slate-400 mt-1 text-center">Powered by ChatGPT</p>
    </div>
  </div>

  <!-- JavaScript del Chatbot -->
  <script>
    const chatWindow = document.getElementById('chatWindow');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    let chatOpen = false;

    function toggleChat() {
      chatOpen = !chatOpen;
      if (chatOpen) {
        chatWindow.classList.remove('hidden');
        chatToggleBtn.innerHTML = '‚úñÔ∏è';
        chatToggleBtn.classList.remove('animate-bounce-slow');
        chatInput.focus();
      } else {
        chatWindow.classList.add('hidden');
        chatToggleBtn.innerHTML = 'üí¨';
        chatToggleBtn.classList.add('animate-bounce-slow');
      }
    }

    async function sendChatMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      addChatMessage(message, 'user');
      chatInput.value = '';
      chatSendBtn.disabled = true;
      chatSendBtn.innerHTML = '‚è≥';

      const typingId = addTypingIndicator();

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: message })
        });

        const data = await response.json();
        removeTypingIndicator(typingId);

        if (data.success) {
          addChatMessage(data.response, 'bot');
        } else {
          addChatMessage('‚ùå ' + (data.error || 'Error al procesar'), 'bot');
        }
      } catch (error) {
        removeTypingIndicator(typingId);
        addChatMessage('‚ùå Error de conexi√≥n', 'bot');
      } finally {
        chatSendBtn.disabled = false;
        chatSendBtn.innerHTML = 'üì§';
        chatInput.focus();
      }
    }

    function addChatMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start gap-2 animate-slideUp';
      
      if (sender === 'user') {
        messageDiv.classList.add('flex-row-reverse');
        messageDiv.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-cocoAccent to-pink-500 flex items-center justify-center text-white text-sm font-bold flex-shrink-0">üë§</div>
          <div class="bg-gradient-to-br from-cocoAccent/20 to-pink-200/50 rounded-2xl rounded-tr-none px-4 py-2 shadow-sm max-w-[75%] border border-pink-200">
            <p class="text-sm">${escapeHtml(text)}</p>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-cocoPrimary to-cocoAccent flex items-center justify-center text-white text-sm font-bold flex-shrink-0">ü§ñ</div>
          <div class="bg-white rounded-2xl rounded-tl-none px-4 py-2 shadow-sm max-w-[75%] border border-slate-100">
            <p class="text-sm">${formatBotMessage(text)}</p>
          </div>
        `;
      }

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.id = 'typingIndicator';
      typingDiv.className = 'flex items-start gap-2';
      typingDiv.innerHTML = `
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-cocoPrimary to-cocoAccent flex items-center justify-center text-white text-sm font-bold flex-shrink-0">ü§ñ</div>
        <div class="bg-white rounded-2xl rounded-tl-none px-4 py-2 shadow-sm border border-slate-100">
          <div class="flex gap-1">
            <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
          </div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return 'typingIndicator';
    }

    function removeTypingIndicator(id) {
      const indicator = document.getElementById(id);
      if (indicator) indicator.remove();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatBotMessage(text) {
      text = escapeHtml(text);
      text = text.replace(/\n/g, '<br>');
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
      text = text.replace(/- (.*?)(<br>|$)/g, '<span class="block ml-2">‚Ä¢ $1</span>');
      text = text.replace(/(\d+)\. (.*?)(<br>|$)/g, '<span class="block ml-2">$1. $2</span>');
      return text;
    }
  </script>
</body>
</html>